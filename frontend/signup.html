<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Community Cash Swap - Signup</title>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }
    .container{background:white;padding:2rem;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);width:100%;max-width:400px}
    .header{text-align:center;margin-bottom:2rem}
    .header h2{color:#667eea;margin-bottom:.5rem}
    .header p{color:#666;font-size:.9rem}
    .form-group{margin-bottom:1.25rem}
    label{display:block;margin-bottom:.5rem;color:#333;font-weight:500}
    input{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:8px;font-size:1rem;transition:border-color .3s}
    input:focus{outline:none;border-color:#667eea}
    .btn{width:100%;padding:12px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;margin-bottom:1rem}
    .btn-primary{background:#667eea;color:#fff}
    .btn-primary:hover{transform:translateY(-2px)}
    .btn-secondary{background:#f8f9fa;color:#667eea;border:2px solid #667eea}
    .btn-secondary[disabled]{opacity:.6;cursor:not-allowed}
    .status{text-align:center;padding:1rem;border-radius:8px;margin-top:1rem;display:none}
    .status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .login-link{text-align:center;margin-top:1rem}
    .login-link a{color:#667eea;text-decoration:none}
    .hint{font-size:.85rem;color:#666;margin-top:.25rem}
    .small{font-size:.85rem;color:#444}
  </style>
</head>
<body>
  <script>
    // if this function exists in auth.js it'll run; keeps your original redirect behavior
    if (typeof redirectIfAuthenticated === 'function') {
      try { redirectIfAuthenticated(); } catch(e) { /* ignore */ }
    }
  </script>

  <div class="container" role="main" aria-labelledby="signupHeading">
    <div class="header">
      <h2 id="signupHeading">ðŸ’° Create Account</h2>
      <p>Join College Cash Swap today!</p>
    </div>

    <form id="signupForm" autocomplete="on" novalidate>
      <div class="form-group">
        <label for="firstName">First Name:</label>
        <input id="firstName" name="firstName" type="text" required maxlength="50" />
      </div>

      <div class="form-group">
        <label for="secondName">Second Name:</label>
        <input id="secondName" name="secondName" type="text" required maxlength="50" />
      </div>

      <div class="form-group">
        <label for="email">Email:</label>
        <input id="email" name="email" type="email" required />
      </div>

      <button type="button" id="otpButton" class="btn btn-secondary">Send OTP</button>
      <div class="hint small" id="otpHint">You will receive a 6-digit OTP via email. (Valid for a few minutes)</div>

      <div class="form-group" style="margin-top:.75rem">
        <label for="otp">Enter OTP:</label>
        <input id="otp" name="otp" type="text" inputmode="numeric" pattern="\\d{6}" maxlength="6" required />
      </div>

      <div class="form-group">
        <label for="password">Password:</label>
        <input id="password" name="password" type="password" required minlength="8" />
        <div class="hint">Use at least 8 characters with upper/lowercase and a number.</div>
      </div>

      <button type="submit" id="signupBtn" class="btn btn-primary">Create Account</button>
    </form>

    <div id="status" class="status" aria-live="polite"></div>

    <div class="login-link">
      Already have an account? <a href="login.html">Login here</a>
    </div>
  </div>

  <script>
    // === Utilities ===
    const apiBase = (typeof API_BASE_URL !== 'undefined' && API_BASE_URL) ? API_BASE_URL.replace(/\/$/, '') : `${location.origin}`;
    const otpButton = document.getElementById('otpButton');
    const signupBtn = document.getElementById('signupBtn');
    const statusDiv = document.getElementById('status');

    function showStatus(message, type = 'error') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      if (type === 'success') {
        // success auto-hide after 5s
        setTimeout(()=> { statusDiv.style.display = 'none'; }, 5000);
      }
    }

    function clearStatus() {
      statusDiv.style.display = 'none';
      statusDiv.textContent = '';
    }

    function startOtpCooldown(seconds = 60) {
      otpButton.disabled = true;
      const orig = otpButton.textContent;
      let t = seconds;
      otpButton.textContent = `Resend OTP (${t}s)`;
      const iv = setInterval(() => {
        t--;
        otpButton.textContent = `Resend OTP (${t}s)`;
        if (t <= 0) {
          clearInterval(iv);
          otpButton.disabled = false;
          otpButton.textContent = orig;
        }
      }, 1000);
    }

    // === Send OTP ===
    otpButton.addEventListener('click', async () => {
      clearStatus();
      const email = (document.getElementById('email').value || '').trim();
      if (!email) { showStatus('Please enter your email first.', 'error'); return; }

      otpButton.disabled = true;
      otpButton.textContent = 'Sending...';

      try {
        const res = await fetch(`${apiBase}/send-otp`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email })
        });

        const body = await res.json().catch(()=>({ message: res.statusText }));

        if (res.ok) {
          showStatus(body.message || 'OTP sent to your email.', 'success');
          startOtpCooldown(60);
        } else {
          showStatus(body.message || `Failed to send OTP (status ${res.status})`, 'error');
          // small cooldown even on error to prevent immediate retry abuse
          startOtpCooldown(10);
        }
      } catch (err) {
        console.error('Error sending OTP:', err);
        showStatus('Error sending OTP. Please check your network and try again.', 'error');
        startOtpCooldown(10);
      } finally {
        // ensure button state is consistent (cooldown manages re-enable)
        if (!otpButton.disabled) otpButton.disabled = false;
        if (otpButton.textContent === 'Sending...') otpButton.textContent = 'Send OTP';
      }
    });

    // === Signup submit ===
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearStatus();

      // basic client-side validations
      const firstName = (document.getElementById('firstName').value || '').trim();
      const secondName = (document.getElementById('secondName').value || '').trim();
      const email = (document.getElementById('email').value || '').trim();
      const password = document.getElementById('password').value || '';
      const otp = (document.getElementById('otp').value || '').trim();

      if (!firstName || !secondName || !email || !password || !otp) {
        showStatus('Please fill all fields and enter the OTP.', 'error');
        return;
      }
      if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
        showStatus('OTP must be a 6-digit number.', 'error');
        return;
      }
      if (password.length < 8) {
        showStatus('Password must be at least 8 characters long.', 'error');
        return;
      }

      signupBtn.disabled = true;
      signupBtn.textContent = 'Creating...';

      try {
        const res = await fetch(`${apiBase}/signup`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ firstName, secondName, email, password, otp })
        });

        const data = await res.json().catch(()=>({ message: res.statusText }));

        if (res.ok) {
          showStatus(data.message || 'Signup successful!', 'success');
          // redirect to login after a short pause
          setTimeout(()=> { window.location.href = 'login.html'; }, 1800);
        } else {
          // if backend returns validation errors array
          if (data && data.errors && Array.isArray(data.errors) && data.errors.length) {
            showStatus(data.errors.map(e => e.msg).join(' â€” '), 'error');
          } else {
            showStatus(data.message || 'Signup failed. Please try again.', 'error');
          }
        }
      } catch (err) {
        console.error('Signup failed:', err);
        showStatus('Signup failed due to network or server error.', 'error');
      } finally {
        signupBtn.disabled = false;
        signupBtn.textContent = 'Create Account';
      }
    });
  </script>
</body>
</html>
