<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Post Request - College Cash Swap</title>
  <style>
    /* (kept your original styles) */
    /* ... styles omitted here for brevity in this reply; keep the styles from your original file unchanged ... */
  </style>
</head>
<body>
  <header>
    <nav class="container">
      <div class="logo">üí∞ College Cash Swap</div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="request.html">Post Request</a>
        <a href="requests.html">Browse</a>
        <a href="#" onclick="logout()" style="color: #dc3545;">Logout</a>
      </div>
    </nav>
  </header>

  <main class="main-content">
    <div class="container">
      <div class="page-title">
        <h1>Post Your Swap Request</h1>
        <p>Connect with students nearby to exchange cash for digital money or vice versa</p>
      </div>

      <div class="content-grid">
        <!-- Request Form Section -->
        <div class="form-section">
          <h2 class="section-title">üìù Create Request</h2>

          <div id="locationStatus" class="location-status">
            <span class="status-icon">üìç</span>
            <span>Getting your location...</span>
          </div>

          <div id="successMessage" class="success-message"></div>
          <div id="errorMessage" class="error-message"></div>

          <form id="requestForm">
            <div class="form-group">
              <label for="name">Your Name</label>
              <input type="text" id="name" required placeholder="Enter your full name">
            </div>

            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" required placeholder="your.email@example.com">
            </div>

            <div class="form-group">
              <label for="have">What do you have?</label>
              <select id="have" required>
                <option value="">Select what you have</option>
                <option value="cash">üíµ Cash</option>
                <option value="digital">üí≥ Digital Money</option>
              </select>
            </div>

            <div class="form-group">
              <label for="want">What do you want?</label>
              <select id="want" required>
                <option value="">Select what you want</option>
                <option value="cash">üíµ Cash</option>
                <option value="digital">üí≥ Digital Money</option>
              </select>
            </div>

            <div class="form-group">
              <label for="amount">Amount (‚Çπ)</label>
              <div class="amount-input">
                <input type="number" id="amount" required placeholder="Enter amount" min="1">
              </div>
            </div>

            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">

            <button type="submit" class="submit-btn" id="submitBtn">
              <span id="btnText">üöÄ Post Request</span>
              <div class="loading" id="loading" style="display:none;">
                <div class="spinner"></div>
                <span>Processing...</span>
              </div>
            </button>
          </form>
        </div>

        <!-- Matches Section -->
        <div class="matches-section">
          <h2 class="section-title">üîç Nearby Matches</h2>
          <p style="text-align: center; color: #666; margin-bottom: 2rem;">
            Find students who want what you have and have what you want
          </p>

          <ul id="matchesList" class="matches-list">
            <li class="no-matches">Post a request to see matching offers nearby</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Chat Overlay (keeps your original markup) -->
  <div id="chatOverlay" class="chat-overlay">
    <div class="chat-container">
      <div class="chat-header">
        <h3 id="chatTitle">Chat with Match</h3>
        <button class="close-chat" id="closeChat">√ó</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="no-messages">Start a conversation to coordinate your exchange!</div>
      </div>
      <div class="chat-input-container">
        <form id="chatForm" class="chat-input-form">
          <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." required>
          <button type="submit" class="send-message-btn" id="sendMessageBtn">‚û§</button>
        </form>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    // Safe API base (fallback if config.js fails)
    const API = (typeof API_BASE_URL !== 'undefined' && API_BASE_URL) ? API_BASE_URL.replace(/\/$/, '') : location.origin;

    // Require auth and return early after redirect instead of throwing
    if (!requireAuth()) {
      // requireAuth() will redirect to login if needed; stop executing further script
      // This prevents unintended errors after redirect.
      console.warn('Not authenticated ‚Äî redirecting to login.');
      // Don't run any further initialization on this page.
      return;
    }

    // DOM elements
    const form = document.getElementById('requestForm');
    const haveSelect = document.getElementById('have');
    const wantSelect = document.getElementById('want');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const loading = document.getElementById('loading');
    const locationStatus = document.getElementById('locationStatus');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const chatOverlay = document.getElementById('chatOverlay');
    const closeChat = document.getElementById('closeChat');
    const chatTitle = document.getElementById('chatTitle');
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');

    // State
    let currentConversationId = null;
    let currentMatchEmail = null;
    let currentUserEmail = null;
    let currentRequestId = null;
    let messagePollingInterval = null;

    // Prefill user info from local storage
    (function prefillUser() {
      try {
        const user = (typeof getCurrentUser === 'function') ? getCurrentUser() : (localStorage.getItem('userData') ? JSON.parse(localStorage.getItem('userData')) : null);
        if (user) {
          currentUserEmail = user.email || '';
          // fill inputs if empty
          if (!document.getElementById('email').value) document.getElementById('email').value = currentUserEmail;
          // Try to populate name from available fields
          if (!document.getElementById('name').value) {
            const name = user.firstName ? (user.firstName + (user.secondName ? ' ' + user.secondName : '')) : (user.name || '');
            if (name) document.getElementById('name').value = name;
          }
        }
      } catch (e) { /* ignore */ }
    })();

    // Auto-sync 'want' with 'have'
    haveSelect.addEventListener('change', () => {
      const haveValue = haveSelect.value;
      if (haveValue === 'cash') {
        wantSelect.value = 'digital';
      } else if (haveValue === 'digital') {
        wantSelect.value = 'cash';
      }
    });

    // Geolocation
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            document.getElementById('latitude').value = position.coords.latitude;
            document.getElementById('longitude').value = position.coords.longitude;

            locationStatus.className = 'location-status success';
            locationStatus.innerHTML = `
              <span class="status-icon">‚úÖ</span>
              <span>Location captured successfully</span>
            `;
          },
          (error) => {
            console.error("Location error:", error);
            locationStatus.className = 'location-status error';
            locationStatus.innerHTML = `
              <span class="status-icon">‚ö†Ô∏è</span>
              <span>Location access denied. Please enable location services.</span>
            `;
          }
        );
      } else {
        locationStatus.className = 'location-status error';
        locationStatus.innerHTML = `
          <span class="status-icon">‚ùå</span>
          <span>Geolocation not supported by this browser</span>
        `;
      }
    }

    // Messages UI helpers
    function showMessage(type, message) {
      const messageElement = type === 'success' ? successMessage : errorMessage;
      messageElement.textContent = message;
      messageElement.style.display = 'block';
      setTimeout(() => { messageElement.style.display = 'none'; }, 5000);
    }

    function setLoading(isLoading) {
      if (isLoading) {
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        loading.style.display = 'block';
      } else {
        submitBtn.disabled = false;
        btnText.style.display = 'block';
        loading.style.display = 'none';
      }
    }

    // Chat functions
    function openChat(matchName, matchEmail, userEmail, requestId) {
      currentMatchEmail = matchEmail;
      currentUserEmail = userEmail || currentUserEmail;
      chatTitle.textContent = `Chat with ${matchName}`;
      chatOverlay.style.display = 'flex';
      currentRequestId = requestId || null;
      createOrGetConversation(matchEmail, currentUserEmail, currentRequestId);
      startMessagePolling();
    }

    function closeChatOverlay() {
      chatOverlay.style.display = 'none';
      currentConversationId = null;
      currentMatchEmail = null;
      if (messagePollingInterval) { clearInterval(messagePollingInterval); messagePollingInterval = null; }
    }

    async function createOrGetConversation(user1Email, user2Email, requestId = null) {
      try {
        const response = await fetchWithAuth(`${API}/conversation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user1Email: user1Email,
            user2Email: user2Email,
            requestId: requestId || ''
          })
        });
        if (!response.ok) {
          const err = await response.json().catch(()=>({ message: response.statusText }));
          throw new Error(err.message || 'Failed to create/get conversation');
        }
        const data = await response.json();
        currentConversationId = data.conversationId;
        loadMessages();
      } catch (error) {
        console.error('Error creating conversation:', error);
        showMessage('error', 'Failed to start chat. Please try again.');
      }
    }

    async function loadMessages() {
      if (!currentConversationId) return;
      try {
        const response = await fetchWithAuth(`${API}/messages/${currentConversationId}`);
        if (!response.ok) return;
        const messages = await response.json();
        displayMessages(messages);
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    function displayMessages(messages) {
      chatMessages.innerHTML = '';
      if (!messages || messages.length === 0) {
        chatMessages.innerHTML = '<div class="no-messages">Start a conversation to coordinate your exchange!</div>';
        return;
      }
      messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.sender === currentUserEmail ? 'sent' : 'received'}`;
        const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageDiv.innerHTML = `
          <div class="message-bubble">${message.content}</div>
          <div class="message-time">${time}</div>
        `;
        chatMessages.appendChild(messageDiv);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage(content) {
      if (!currentConversationId || !content.trim()) return;
      try {
        const response = await fetchWithAuth(`${API}/send-message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            conversationId: currentConversationId,
            sender: currentUserEmail,
            content: content.trim()
          })
        });
        if (response.ok) loadMessages();
      } catch (error) {
        console.error('Error sending message:', error);
        showMessage('error', 'Failed to send message. Please try again.');
      }
    }

    function startMessagePolling() {
      if (messagePollingInterval) clearInterval(messagePollingInterval);
      messagePollingInterval = setInterval(() => {
        if (currentConversationId) loadMessages();
      }, 3000);
    }

    // Event listeners for chat
    closeChat.addEventListener('click', closeChatOverlay);
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = chatInput.value;
      chatInput.value = '';
      await sendMessage(content);
    });

    // Fetch matches by calling backend with location and 'have'
    async function fetchMatches(have, location) {
      try {
        const matchRes = await fetchWithAuth(`${API}/matching-requests`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ have, location })
        });
        if (!matchRes.ok) throw new Error('Fetch matches failed');
        const matches = await matchRes.json();
        const matchList = document.getElementById('matchesList');
        matchList.innerHTML = '';
        if (!matches || matches.length === 0) {
          matchList.innerHTML = '<li class="no-matches">No matching requests found near you.</li>';
        } else {
          matches.forEach(req => {
            const li = document.createElement('li');
            li.className = 'match-item';
            // create chat button that references currentUserEmail and request id
            const chatBtn = document.createElement('button');
            chatBtn.className = 'chat-btn';
            chatBtn.textContent = 'üí¨ Start Chat';
            chatBtn.addEventListener('click', () => openChat(req.name, req.email, currentUserEmail, req._id || req.requestId || null));

            li.innerHTML = `
              <div class="match-header">
                <span class="match-name">${req.name}</span>
                <span class="match-amount">‚Çπ${req.amount}</span>
              </div>
              <div class="match-details">
                Has: <strong>${req.have === 'cash' ? 'üíµ Cash' : 'üí≥ Digital Money'}</strong><br>
                Wants: <strong>${req.want === 'cash' ? 'üíµ Cash' : 'üí≥ Digital Money'}</strong>
              </div>
            `;
            li.appendChild(chatBtn);
            matchList.appendChild(li);
          });
        }
      } catch (error) {
        console.error('Error fetching matches:', error);
        const matchList = document.getElementById('matchesList');
        matchList.innerHTML = '<li class="no-matches">Error loading matches. Please try again.</li>';
      }
    }

    // Submit form to post a request
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setLoading(true);
      try {
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        const have = document.getElementById('have').value;
        const want = document.getElementById('want').value;
        const amount = Number(document.getElementById('amount').value);
        const lat = parseFloat(document.getElementById('latitude').value);
        const lon = parseFloat(document.getElementById('longitude').value);

        if (!lat || !lon) {
          showMessage('error', 'Please allow location access to post your request.');
          setLoading(false);
          return;
        }
        if (!name || !email || !have || !want || !amount) {
          showMessage('error', 'Please fill all required fields.');
          setLoading(false);
          return;
        }
        if (have === want) {
          showMessage('error', "You can't request the same thing you already have.");
          setLoading(false);
          return;
        }

        const location = { type: "Point", coordinates: [lon, lat] };

        const res = await fetchWithAuth(`${API}/post-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, have, want, amount, location })
        });

        const data = await res.json().catch(()=>({ message: res.statusText }));

        if (res.ok) {
          showMessage('success', data.message || 'Request posted successfully!');
          form.reset();
          // re-fill email/name from current user again
          if (currentUserEmail) document.getElementById('email').value = currentUserEmail;
          // fetch matches using newly posted request
          await fetchMatches(have, location);
        } else {
          showMessage('error', data.message || 'Failed to post request');
        }
      } catch (error) {
        console.error('Error posting request:', error);
        showMessage('error', 'Network error. Please check your connection and try again.');
      } finally {
        setLoading(false);
      }
    });

    // Initialize geolocation
    getLocation();
  </script>
</body>
</html>
